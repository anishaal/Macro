import tkinter as tk
from tkinter import messagebox # Kept for reference, but custom dialogs are used
import win32com.client as win32
import os

# --- Configuration ---
EXCEL_FILE = r"C:\Users\anisl\Downloads\25R1_NR_12112025 1\25R1_NR_12112025\5G_CIQ_DataMap_V1_Updated_TD_V4.xlsm"
MACRO_NAME = "Main"

# --- Nokia-inspired Color Palette ---
NOKIA_BLUE = "#006FBB"  # A distinct Nokia blue
NOKIA_DARK_BLUE = "#005A99" # Slightly darker for active states
NOKIA_LIGHT_GREY = "#F0F0F0" # Light background
NOKIA_DARK_GREY = "#333333" # Text color
NOKIA_WHITE = "#FFFFFF" # White for text on dark backgrounds
NOKIA_RED = "#CC0000" # For error messages
NOKIA_ORANGE = "#FF9900" # For warning messages

# --- Custom Message Dialog Function ---
def show_custom_message(title, message, message_type="info"):
    """
    Displays a custom message dialog with Nokia-themed styling.
    message_type can be "info", "warning", or "error".
    """
    dialog = tk.Toplevel(root)
    dialog.title(title)
    dialog.transient(root) # Make it appear on top of the main window
    dialog.grab_set() # Make it modal, blocking interaction with the main window
    dialog.resizable(False, False)

    # Center the dialog over the main window
    root_x = root.winfo_x()
    root_y = root.winfo_y()
    root_width = root.winfo_width()
    root_height = root.winfo_height()

    dialog_width = 350
    dialog_height = 150
    dialog.geometry(f"{dialog_width}x{dialog_height}")

    center_x = root_x + root_width // 2 - dialog_width // 2
    center_y = root_y + root_height // 2 - dialog_height // 2
    dialog.geometry(f"+{center_x}+{center_y}")

    # Determine colors based on message type
    bg_color = NOKIA_LIGHT_GREY
    text_color = NOKIA_DARK_GREY
    button_bg = NOKIA_BLUE
    button_fg = NOKIA_WHITE
    active_button_bg = NOKIA_DARK_BLUE

    if message_type == "error":
        bg_color = NOKIA_RED
        text_color = NOKIA_WHITE
        button_bg = NOKIA_DARK_GREY
        active_button_bg = NOKIA_BLUE
    elif message_type == "warning":
        bg_color = NOKIA_ORANGE
        text_color = NOKIA_DARK_GREY
        button_bg = NOKIA_DARK_GREY
        active_button_bg = NOKIA_BLUE

    dialog.configure(bg=bg_color)

    message_label = tk.Label(
        dialog,
        text=message,
        font=("Arial", 10),
        bg=bg_color,
        fg=text_color,
        wraplength=dialog_width - 40 # Wrap text to fit within the dialog
    )
    message_label.pack(pady=20, padx=20, expand=True)

    ok_button = tk.Button(
        dialog,
        text="OK",
        font=("Arial", 10, "bold"),
        command=dialog.destroy, # Closes the dialog
        bg=button_bg,
        fg=button_fg,
        activebackground=active_button_bg,
        activeforeground=NOKIA_WHITE,
        relief="flat",
        padx=10,
        pady=5,
        cursor="hand2"
    )
    ok_button.pack(pady=(0, 15))

    root.wait_window(dialog) # Wait for the user to close the dialog

# --- Functions ---
def run_macro():
    """
    Validates input, checks for Excel file existence, and runs the specified Excel macro.
    Displays appropriate messages for success, warnings, or errors using custom dialogs.
    """
    site_id = entry.get().strip()

    if not site_id:
        show_custom_message("Input Error", "Please enter a Site ID.", "warning")
        return

    if not os.path.exists(EXCEL_FILE):
        show_custom_message("File Error", "Excel macro file not found at:\n" + EXCEL_FILE, "error")
        return

    excel = None # Initialize excel to None
    try:
        show_custom_message("Running", "Running macro, please wait...", "info")

        excel = win32.Dispatch("Excel.Application")
        excel.Visible = False  # Run in background

        wb = excel.Workbooks.Open(EXCEL_FILE)

        # Note: The original code does not pass site_id to the macro directly.
        # If your macro needs the site_id, you'll need to modify the macro or
        # write the site_id to a specific cell before running the macro.
        excel.Application.Run(f"'{wb.Name}'!{MACRO_NAME}")

        wb.Close(SaveChanges=True)
        excel.Quit()

        show_custom_message("Success", "Macro completed successfully!", "info")

    except Exception as e:
        show_custom_message("Error", f"An error occurred during macro execution:\n{e}", "error")
    finally:
        # Ensure Excel is properly closed even if an error occurs
        if excel: # Check if excel object was successfully created
            excel.Quit()

# --- UI Setup ---
root = tk.Tk()
root.title("Nokia Site Macro Runner")
root.geometry("350x200")
root.resizable(False, False)
root.configure(bg=NOKIA_LIGHT_GREY)

# Label for Site ID input
label = tk.Label(
    root,
    text="Enter Site ID:",
    font=("Arial", 12, "bold"),
    bg=NOKIA_LIGHT_GREY,
    fg=NOKIA_DARK_GREY
)
label.pack(pady=(20, 5))

# Entry field for Site ID
entry = tk.Entry(
    root,
    width=30,
    font=("Arial", 12),
    bg=NOKIA_WHITE,
    fg=NOKIA_DARK_GREY,
    relief="flat",
    bd=2,
    highlightbackground=NOKIA_BLUE,
    highlightthickness=1
)
entry.pack(pady=5)

# Run Macro button
run_button = tk.Button(
    root,
    text="Run Macro",
    font=("Arial", 12, "bold"),
    command=run_macro,
    bg=NOKIA_BLUE,
    fg=NOKIA_WHITE,
    activebackground=NOKIA_DARK_BLUE,
    activeforeground=NOKIA_WHITE,
    relief="flat",
    padx=15,
    pady=8,
    cursor="hand2"
)
run_button.pack(pady=20)

root.mainloop()
